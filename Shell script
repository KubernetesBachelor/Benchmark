#!/bin/bash

echo "Starter stresstesting av konteineren ..."
resultatfil="sysbench_resultater.txt"

# Sørger for at filen er tom før vi starter
echo "" > "$resultatfil"

# Definerer array for trådantall og cpu-max-prime verdier
threads=(1 2)
primes=(10000 20000 30000)

# Ytre løkke for antall tråder
for t in "${threads[@]}"; do
  # Indre løkke for cpu-max-prime verdiene
  for p in "${primes[@]}"; do
    # Kjører testen 10 ganger
    for i in {1..10}; do
      echo "Test $i: Starter CPU-test med ${t} tråd(er) og cpu-max-prime=${p} for 30 sekunder..." >> "$resultatfil"
      # Kjører sysbench med tidsbegrensning
      output=$(sysbench cpu --cpu-max-prime="$p" --threads="$t" --time=30 run)
      echo "$output" | grep -E "total time|total number of events" >> "$resultatfil"
      echo "Tråder: ${t}, cpu-max-prime=${p}, Test $i fullført" >> "$resultatfil"
      echo "--------------------------------------------------" >> "$resultatfil"
      sleep 5
    done
  done
done

# Minnetest 1 - Lese
echo "Starter minnetest i lesemodus ..."
output=$(sysbench memory --memory-block-size=128M --memory-total-size=1G --memory-oper=read --threads=1 run)
#Justere grep
filtered_output=$(echo "$output" | grep -oP "\d+(\.\d+)? MiB transferred \(\d+(\.\d+)? MiB/sec\)" | uniq)

echo "Lese: $filtered_output" >> "$resultatfil"
echo "Minnetest i lesemodus fullført." >> "$resultatfil"
echo "--------------------------------------------------" >> "$resultatfil"
sleep 5

# Minnetest 2 - Skrive
echo "Starter minnetest i skrivemodus ..."
output=$(sysbench memory --memory-block-size=128M --memory-total-size=1G --memory-oper=write --threads=1 run)
filtered_output=$(echo "$output" | grep -oP "\d+(\.\d+)? MiB transferred \(\d+(\.\d+)? MiB/sec\)" | uniq)

echo "Skrive: $filtered_output" >> "$resultatfil"
echo "Minnetest i skrivemodus fullført." >> "$resultatfil"
echo "--------------------------------------------------" >> "$resultatfil"
sleep 5


echo "Testene er fullført og resultatene er lagret i $resultatfil."

# Disk I/O test
kjor_fio_test () {
  modus="$1" # write eller read
  echo "Starter $modus test ..." >> "$resultatfil"
  output=$(fio --name=seq_"$modus"_test --ioengine=sync --rw="$modus" --bs=1M --direct=1 --iodepth=2 --size=2G --numjobs=1 --runtime=60 --filename=/home/tropisk/Bachelor/vm/testfile --group_reporting)
  
  # Lagrer fullstendig output i en separat fil for gjennomgang
  echo "$output" >> "fio_full_output_$modus.txt"
  
  # Ekstraherer IOPS-verdien ved hjelp av grep og Perl-kompatible regex-uttrykk
  iops=$(echo "$output" | grep "IOPS=" | grep -oP "(?<=IOPS=)\d+")
  
  # Skriver filtrert resultat for IOPS til resultatfilen
  echo "Sekvensiell $modus: IOPS = $iops" >> "$resultatfil"
  echo "Fio $modus test fullført." >> "$resultatfil"
  echo "--------------------------------------------------" >> "$resultatfil"
}

# Kjører fio-tester for sekvensiell skriving og lesing
kjor_fio_test write
kjor_fio_test read

echo "Alle tester fullført. Systemet ble testet til sine yttergrenser."
